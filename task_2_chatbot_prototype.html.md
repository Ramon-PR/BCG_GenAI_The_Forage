# Load data / Manually input the data


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_base_dir

>  get_base_dir ()

``` python
base_dir = get_base_dir()
path_to_data = base_dir.parent / "resources"
file_name = "financial_data_chatbot.csv"
file_path = path_to_data / file_name
```

# Data class for the chatbot

## Scheme for the chatbot:

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L28"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot

>  financial_chatbot (file_path:pathlib.Path)

*Initialize self. See help(type(self)) for accurate signature.*

``` python
chatbot = financial_chatbot(file_path=file_path)
```

``` python
chatbot.print_intro()
```

``` python
chatbot._available_companies
```

0.  I need a company or companies to query
    - I should have a current company field that gets updated when
      parsing for companies
    - If there is no Company in the query I continue applyin things to
      the `current_company`
    - If after parsing everything `current_company` is empty, I have to
      ask for the company.
1.  From the query I need an action keyword:
    - actions:
      - \[‘show’, ‘print’, ‘get’, ‘display’, ‘tell’, ‘give’, “how”,
        “what”\]
      - \[‘plot’, ‘graph’, ‘chart’, ‘visualize’, ‘draw’\]
2.  I also need a subject keyword or keywords to ignore:
    - stopwords = {‘the’, ‘and’, ‘of’, ‘from’, ‘a’, ‘an’, ‘in’, ‘on’,
      ‘at’, ‘for’, ‘to’, ‘total’}
3.  And adjectives keywords to classify:
    - adjectives:
      - \[‘growth’, ‘change’, ‘increase’, ‘decrease’\]

## Methods to parse and prompt for missing information

### Method to parse and update the companies

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L101"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.parse_companies

>  financial_chatbot.parse_companies ()

``` python
chatbot._current_query = "Give me the Net income for APPLE."
print(f"Parsed companies: {chatbot.parse_companies()}")
print(f"Active companies: {chatbot._current_companies}")
```

If no companies in the query, ask for what companies

### Method to initiate the possible actions

Associate keywords with a function

``` python
# The list of all trigger words (synonyms)
print_keywords = set(['print', 'give me', 'show', 'display', 'output'])
plot_keywords = set(['plot', 'graph', 'chart', 'visualize'])

# The dictionary that will hold the final mapping
action_for = {}
```

Function to populate the dictionary that maps keywords with functions

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L115"
target="_blank" style="float:right; font-size:smaller">source</a>

### associate_action

>  associate_action (keywords, function, dictionary)

Populate and test the dictionary

``` python
action_for = associate_action(print_keywords, print, action_for)
action_for = associate_action(plot_keywords, plt.plot, action_for)
```

``` python
action_for['show']("Hello, World!")
```

``` python
action_for['graph']([1, 2, 3], [4, 5, 6])
```

Include this functionality as a method

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L413"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.initiate_actions_dictionary

>  financial_chatbot.initiate_actions_dictionary ()

### Parse for the action

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L130"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.parse_action

>  financial_chatbot.parse_action ()

``` python
chatbot._current_query = "Please plot and print the revenue for Microsoft."
chatbot.initiate_actions_dictionary()
chatbot.parse_action()
```

### Parse for the financial facts

Let’s use the re module to look for patterns in the query.

------------------------------------------------------------------------

``` python
COLUMNS = [
    'Cash Flow from Operations',
    'Cash Flow from Operations growth (%)',
    'Net Income',
    'Net Income growth (%)',
    'Total Assets',
    'Total Assets growth (%)',
    'Total Liabilities',
    'Total Liabilities growth (%)',
    'Total Revenue',
    'Total Revenue growth (%)'
]

# Words that indicate growth/percentage intent
GROWTH_KEYWORDS = {'growth', 'percentage', 'percent', '%', 'increase', 'change', 'yoy', 'annualized'}

# Stopwords to ignore when matching tokens (keeps domain words like 'cash' and 'flow')
STOPWORDS = {'the', 'and', 'of', 'from', 'a', 'an', 'in', 'on', 'at', 'for', 'to', 'total'}
```

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L167"
target="_blank" style="float:right; font-size:smaller">source</a>

### preprocess_columns

>  preprocess_columns (columns, stopwords)

*Converts a list of column names into metadata dictionaries
containing: - original name - lowercase token set (without stopwords) -
is_growth flag*

``` python
cols_meta = preprocess_columns(columns=COLUMNS, stopwords=STOPWORDS)
display(cols_meta)
```

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L201"
target="_blank" style="float:right; font-size:smaller">source</a>

### best_match

>  best_match (part_tokens, cols_meta, allow_growth_flag)

*Return the column/fact that best matches the query best (meta
dictionary) score (int)*

``` python
query = "Find me the revenue and perc income"
print(_tokens(query))


parts = [p.strip() for p in re.split(r',|\band\b', query.lower()) if p.strip()]
print(parts)

for part in parts:
    part_tokens = set(t for t in _tokens(part) if t not in STOPWORDS)
    print("part: ", part)
    print("\t part_tokens:", part_tokens)

print(10*"-")

part_tokens = set(t for t in _tokens(parts[0]) if t not in STOPWORDS)
# bm = best_match(part_tokens, cols_meta, allow_growth_flag=True)
bm = best_match(part_tokens, cols_meta, allow_growth_flag=False)

print("Best_match between my columns and:")
print(parts[0])
print("\t", part_tokens)
print("\t", bm)
```

Summarize in a function

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L233"
target="_blank" style="float:right; font-size:smaller">source</a>

### detect_columns

>  detect_columns (query:str, columns:List[str], growth_words:set[str],
>                      stopwords:set[str])

*1. tokenize the columns that I want to predict, remove or add metadata
relevant to the prediction 2. Divide the query in subqueries or parts (I
may want multiple facts) 3. tokenize each subquery/part 4. For each
subquery, find the best match with my set of columns/financial_facts*

``` python
# --- Examples from your message ---
q1 = "Give me the flow "
q2 = "Give me the revenue and the Total Liabilities"

print(q1, "\n\t->", detect_columns(q1, COLUMNS, GROWTH_KEYWORDS, STOPWORDS))
print(q2, "\n\t->", detect_columns(q2, COLUMNS, GROWTH_KEYWORDS, STOPWORDS))
```

Let’s include this function as a method in the class

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L293"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.parse_financial_facts

>  financial_chatbot.parse_financial_facts ()

``` python
chatbot._current_query = "Print the Net results, Total assets and percentage assets"
chatbot.parse_financial_facts()
```

------------------------------------------------------------------------

### Loop To ask about missing info

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L312"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.query_for_missing_info

>  financial_chatbot.query_for_missing_info (info_type:str,
>                                                prompt_message:str)

#### Tests

``` python
cb = financial_chatbot(file_path=file_path)
cb.initiate_actions_dictionary()
```

Test that the loop stops the program:

``` python
# The user inputs something not valid
__builtins__.input = lambda prompt="": "Fake answer"

try:
    print("Starting...")
    cb.query_for_missing_info(info_type="company", prompt_message="Please specify at least one company in your query: ")
    print("This won't run unless SystemExit is caught")
    
except SystemExit as e:
    print(f"Caught SystemExit: {e}")
```

Test with correct user prompts

``` python
__builtins__.input = lambda prompt="": "Apple and Microsoft"
cb.query_for_missing_info(info_type="company", prompt_message="Please specify at least one company in your query: ")

__builtins__.input = lambda prompt="": "print"
cb.query_for_missing_info(info_type="action", prompt_message="Would you like me to print or plot the data? ")

__builtins__.input = lambda prompt="": "Net income and Total assets growth"
cb.query_for_missing_info(info_type="fact", prompt_message="What financial fact are you interested in?")
```

Method to print the saved information

Results

``` python
cb._print_parsed_information()
```

# Methods to filter and print/plot the queried data

Method to filter the data with the information from the queries

For plotting:

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L375"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.print_queried_data

>  financial_chatbot.print_queried_data (last_n_years:int=2)

*It will print the filtered dataframe with the selected: Companies,
Financial facts and the last 3 years to make it shorter*

``` python
cb.print_queried_data(1)
```

For plotting:

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L392"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.plot_queried_data

>  financial_chatbot.plot_queried_data (last_n_years:int=3)

``` python
cb.plot_queried_data(3)
```

I can overwrite the `initiate_actions_dictionary` method to use the new
methods for print and plot that I have just defined (In a final setup I
could just order everything in a class withouth patches)

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L413"
target="_blank" style="float:right; font-size:smaller">source</a>

### financial_chatbot.initiate_actions_dictionary

>  financial_chatbot.initiate_actions_dictionary ()

``` python
cb.initiate_actions_dictionary()
```

``` python
cb.action_for["print"](1)
```

``` python
cb.action_for["print"](2)
cb.action_for["plot"](2)
```

# Test logic

``` python
test = True

cb = financial_chatbot(file_path=file_path)

# Initiate some variables
cb.initiate_actions_dictionary()


# First message 
cb.print_intro()

# First user query
if test: __builtins__.input = lambda prompt="": "Print and plot the Net income, Total assets and Cash Flow for Apple and Microsoft"
cb.get_response(message="How can I help you?")

# parse query for company
cb.parse_companies()

# parse query for action   
cb.parse_action()

# Parse Financial facts
cb.parse_financial_facts()


# Ask for missing information
cb.query_for_missing_info(info_type="company", prompt_message="Please specify at least one company in your query: ")
cb.query_for_missing_info(info_type="action", prompt_message="Would you like me to print or plot the data? ")
cb.query_for_missing_info(info_type="fact", prompt_message="What financial fact are you interested in?")

print("Summary:")
cb._print_parsed_information()

# At this point if I don't have all the needed information, the chatbot would have stopped
# Execute the action on the given data
print()
print(80*"-")
for action_i in cb._current_action:
    # print(action_i)
    cb.action_for[action_i]()
    print()
    print(80*"-")
```

Wrap everything in a method

Try how the main would look like:

``` python
# Correct user input:
__builtins__.input = lambda prompt="": "Print the growth of Assets for Apple and Microsoft"

# Instantiate a chatbot
chatbot = financial_chatbot(file_path=file_path)

# Start the query loop
# Note: this should be a while True: 
for i in range(2):
    chatbot._chatbot_iteration()
```

# Export the main function

There is some additional code to check if the script is running from an
interactive terminal or a tool like Github CI, so the run does not fail
due to the program asking for user input.

------------------------------------------------------------------------

<a
href="https://github.com/Ramon-PR/BCG_GenAI_The_Forage/blob/main/BCG_GenAI_The_Forage/chatbot.py#L455"
target="_blank" style="float:right; font-size:smaller">source</a>

### is_interactive

>  is_interactive ()
